<html>
    <head>
        <title>YAVM - Yet Another Virtual Machine</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" media="all" href="style.css" />
    </head>
    <body>
        <h1>Yet Another Virtual Machine</h1>

        <p>This project provides 3 features:</p>

        <ul>
            <li>an assembly language</li>
            <li>a compiler</li>
            <li>an interpreter</li>
        </ul>

        <h2>Description</h2>

        <p>The interpreter works with:</p>

        <ul>
            <li>an extensible byte array that will be used as a stack</li>
            <li>a static byte array containing the program to execute</li>
            <li>a stack pointer register</li>
            <li>an instruction pointer register</li>
        </ul>

        <p>The following structures are needed:</p>

        <ul>
            <li>VM (<a href="https://github.com/linkdd/yavm/blob/master/include/yavm/vm.h#L21-28">source code</a>):
            <ul>
                <li>A stack</li>
                <li>A program</li>
                <li>A boolean indicating that the VM is running or not</li>
                <li>A integer containing the exit value of the program</li>
            </ul>
            </li>
            <li>Program (<a href="https://github.com/linkdd/yavm/blob/master/include/yavm/vm.h#L13-19">source code</a>):
            <ul>
                <li>A byte array containing the code</li>
                <li>An integer containing the size of the byte array</li>
                <li>An integer containing the value of the instruction pointer register</li>
            </ul>
            </li>
            <li>Stack (<a href="https://github.com/linkdd/yavm/blob/master/include/yavm/stack.h">source code</a>):
            <ul>
                <li>A byte array containing the stack</li>
                <li>An integer containing the size of the byte array</li>
                <li>An integer containing the value of the stack pointer register</li>
            </ul>
            </li>
        </ul>

        <p>Each byte of the program is an instruction that has to be executed,
        an instruction is described by the following structure:</p>

        <table>
            <tr><th>1 bit</th><th>5 bits</th><th>2 bits</th></tr>
            <tr><td>has operand</td><td>opcode</td><td>size</td></tr>
        </table>

        <p><a href="https://github.com/linkdd/yavm/blob/master/include/yavm/instruction.h">Source code</a></p>

        <p>Instructions that takes parameters can have them on the stack
        (<code>has operand = 0</code>) or in the bytes following the instruction
        (<code>has operand = 1</code>). If the instruction produce a result, it
        will always be pushed on the stack.

        <p>The <code>opcode</code> bits identifies the instruction.</p>

        <p>The <code>size</code> bits identifies the size of the parameters/result:</p>

        <table>
            <tr>
                <th>Value</th>
                <td>00</td>
                <td>01</td>
                <td>10</td>
                <td>11</td>
            </tr>
            <tr>
                <th>Size</th>
                <td>8 bits</td>
                <td>16 bits</td>
                <td>32 bits</td>
                <td>64 bits</td>
            </tr>
        </table>

        <p><b>NB:</b> There are some instructions that are size independant, their
        <code>opcode</code> is then 7 bits long.</p>

        <pre class="code">PUSH8 42
NOT8
PUSH8 1
INT</pre>

        <p>The above code push <code>42</code> on the stack, then apply a binary not on this
        value, and calls the interuption number 1 (interuptions are special
        functions built in the interpreter), which prints the stack head.</p>

        <p>It is translated in the following byte array:</p>
        <table>
            <tr>
                <td>PUSH8 (<code>1 00000 00</code>)</td>
                <td>42</td>
                <td>NOT8 (<code>0 01001 00</code>)</td>
                <td>PUSH8 (<code>1 00000 00</code>)</td>
                <td>1</td>
                <td>INT (<code>0 1111110</code>)</td>
            </tr>
        </table>

        <pre class="code">NOT8 42
PUSH8 1
INT</pre>

        <p>The above code behave identically but we pass the parameters directly
        instead of via the stack.</p>

        <p>It is translated in the following byte array:</p>

        <table>
            <tr>
                <td>NOT8 (<code>1 01001 00</code>)</td>
                <td>42</td>
                <td>INT (<code>1 1111110</code>)</td>
                <td>1</td>
            </tr>
        </table>

        <h2>Implementation</h2>

        <p><b>NB:</b> Using the C headers <code>stdlib.h</code>, <code>stdint.h</code> and <code>stdbool.h</code>,
        we have access to the following types:</p>

        <table>
            <tr><th>Type</th><th>Description</th><th>Bytes</th></tr>
            <tr><td><code>size_t</code></td><td>An (unsigned) integer type capable of storing a memory size (ie. with <code>sizeof()</code>)</td><td>Architecture dependent</td></tr>
            <tr><td><code>(u)int8_t</code></td><td>An (unsigned) integer type capable of storing 8 bits</td><td>1</td></tr>
            <tr><td><code>(u)int16_t</code></td><td>An (unsigned) integer type capable of storing 16 bits</td><td>2</td></tr>
            <tr><td><code>(u)int32_t</code></td><td>An (unsigned) integer type capable of storing 32 bits</td><td>4</td></tr>
            <tr><td><code>(u)int64_t</code></td><td>An (unsigned) integer type capable of storing 64 bits</td><td>8</td></tr>
            <tr><td><code>(u)intptr_t</code></td><td>An (unsigned) integer type capable of storing any pointer</td><td>Architecture dependent</td></tr>
            <tr><td><code>bool</code></td><td>boolean type with values <code>false</code> and <code>true</code> defined</td><td>1</td></tr>
        </table>

        <p><b>NB:</b> Using the C headers <code>stdlib.h</code> and <code>string.h</code> we are able to use the
        following functions:</p>

        <ul>
            <li>
                <a href="http://manpagesfr.free.fr/man/man3/malloc.3.html">calloc</a>:
                to allocate memory <b>and</b> initialize it to <code>0</code>
            </li>
            <li>
                <a href="http://manpagesfr.free.fr/man/man3/malloc.3.html">realloc</a>:
                to resize an already allocated memory area
            </li>
            <li>
                <a href="http://manpagesfr.free.fr/man/man3/memcpy.3.html">memcpy</a>:
                to copy memory (useful for stack manipulation)
            </li>
            <li>
                <a href="http://manpagesfr.free.fr/man/man3/memcmp.3.html">memcmp</a>:
                to compare two memory areas
            </li>
        </ul>

        <p>For the complete list of instructions and what they do:</p>

        <ul>
            <li><a href="stack.html">4 instructions for manipulating the stack</a></li>
            <li><a href="binary.html">10 instructions for binary arithmetic</a></li>
            <li><a href="integer.html">8 instructions for integer arithmetic</a></li>
            <li><a href="fixed-point.html">7 instructions for fixed point arithmetic</a></li>
            <li><a href="comparison.html">1 instruction for comparison</a></li>
            <li><a href="jump.html">4 instructions for jumping</a></li>
            <li><a href="function-call.html">4 instructions dedicated to function calls</a></li>
        </ul>

        <p><b>NB:</b> When there is not enough space left on the stack, it must
        be reallocated with more space:</p>

        <ul>
            <li>when the VM starts, the stack is allocated to 4096 bytes</li>
            <li>before executing an instruction, if there is less than 8 bytes
            remaining, allocate 4096 more bytes with
            <a href="http://manpagesfr.free.fr/man/man3/malloc.3.html">realloc</a>
            </li>
        </ul>

        <p><a href="https://github.com/linkdd/yavm/blob/master/src/stack.c">Source code</a></p>
    </body>
</html>
